<div class="product-location-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Ubicación de Producto</mat-card-title>
    </mat-card-header>

    <mat-card-content>

      <form [formGroup]="searchForm" class="search-form">
        <mat-form-field appearance="outline">
          <mat-label>ID del Producto</mat-label>
          <input matInput type="number" formControlName="productId" placeholder="Ej: 456">
          <mat-icon matIconPrefix>search</mat-icon>
          <mat-error *ngIf="searchForm.get('productId')?.hasError('required')">
            El ID es requerido
          </mat-error>
          <mat-error *ngIf="searchForm.get('productId')?.hasError('min')">
            Debe ser mayor a 0
          </mat-error>
        </mat-form-field>

        <button mat-raised-button color="primary" (click)="onSearch()" [disabled]="isLoading">
          <mat-icon>search</mat-icon>
          {{ isLoading ? 'Buscando...' : 'Buscar' }}
        </button>
      </form>


      <div *ngIf="isLoading" class="loading">
        Cargando ubicación del producto...
      </div>


      <div *ngIf="!isLoading && hasSearched && locationData.length === 0" class="no-data">
        No se encontró información para este producto
      </div>

      <div *ngIf="!isLoading && locationData.length > 0" class="location-results">

        <div class="product-header">
          <div class="product-title">
            <mat-icon class="large-icon">inventory_2</mat-icon>
            <div>
              <h2>{{ locationData[0].product_name }}</h2>
              <p class="subtitle">{{ locationData[0].category }}</p>
            </div>
          </div>
          <div class="status-badge" [class]="'status-' + locationData[0].general_product_status.toLowerCase()">
            {{ locationData[0].general_product_status }}
          </div>
        </div>


        <div class="progress-section">
          <div class="progress-info">
            <span>Progreso de Producción</span>
            <span class="progress-text">{{ locationData[0].completed_tasks }} de {{ locationData[0].total_tasks }} tareas completadas</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
          </div>
          <div class="progress-percentage">{{ getProgressPercentage() }}%</div>
        </div>

        <mat-divider></mat-divider>

 
        <div class="info-section">
          <h3>Información del Pedido</h3>
          <div class="info-grid">
            <div class="info-item">
              <mat-icon>receipt</mat-icon>
              <div>
                <span class="label">ID Pedido</span>
                <span class="value">{{ locationData[0].id_order }}</span>
              </div>
            </div>
            <div class="info-item">
              <mat-icon>person</mat-icon>
              <div>
                <span class="label">Cliente</span>
                <span class="value">{{ locationData[0].customer }}</span>
              </div>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>


        <div class="current-location" *ngIf="currentTask">
          <h3>
            <mat-icon>place</mat-icon>
            Ubicación Actual
          </h3>
          <div class="location-card">
            <div class="location-header">
              <div>
                <h4>{{ currentTask.production_area }}</h4>
                <p class="step-info">Paso {{ currentTask.process_number }} de {{ locationData[0].total_tasks }}</p>
              </div>
              <span class="task-status in-progress">{{ currentTask.task_progress }}</span>
            </div>

            <div class="location-details">
              <div class="detail-item">
                <mat-icon>badge</mat-icon>
                <div>
                  <span class="label">Trabajador Asignado</span>
                  <span class="value">{{ currentTask.worker }}</span>
                </div>
              </div>
              <div class="detail-item">
                <mat-icon>badge</mat-icon>
                <div>
                  <span class="label">Cédula</span>
                  <span class="value">{{ currentTask.worker_cc }}</span>
                </div>
              </div>
              <div class="detail-item">
                <mat-icon>work</mat-icon>
                <div>
                  <span class="label">Rol</span>
                  <span class="value">{{ currentTask.worker_role }}</span>
                </div>
              </div>
              <div class="detail-item" *ngIf="currentTask.start_date">
                <mat-icon>schedule</mat-icon>
                <div>
                  <span class="label">Fecha de Inicio</span>
                  <span class="value">{{ currentTask.start_date }}</span>
                </div>
              </div>
              <div class="detail-item" *ngIf="currentTask.next_area">
                <mat-icon>arrow_forward</mat-icon>
                <div>
                  <span class="label">Siguiente Área</span>
                  <span class="value">{{ currentTask.next_area }}</span>
                </div>
              </div>
              <div class="detail-item full-width" *ngIf="currentTask.consumed_materials">
                <mat-icon>inventory</mat-icon>
                <div>
                  <span class="label">Materiales Consumidos</span>
                  <span class="value">{{ currentTask.consumed_materials }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>


        <div class="completed-tasks" *ngIf="completedTasks.length > 0">
          <h3>
            <mat-icon>check_circle</mat-icon>
            Tareas Completadas
          </h3>
          <div class="tasks-list">
            <div *ngFor="let task of completedTasks" class="task-item completed">
              <div class="task-header">
                <span class="task-title">{{ task.production_area }}</span>
                <mat-icon class="check-icon">check_circle</mat-icon>
              </div>
              <div class="task-info">
                <span>Trabajador: {{ task.worker }}</span>
                <span>Completado: {{ task.end_date }}</span>
              </div>
            </div>
          </div>
        </div>


        <div class="pending-tasks" *ngIf="pendingTasks.length > 0">
          <h3>
            <mat-icon>pending</mat-icon>
            Tareas Pendientes
          </h3>
          <div class="tasks-list">
            <div *ngFor="let task of pendingTasks" class="task-item pending">
              <div class="task-header">
                <span class="task-title">{{ task.production_area }}</span>
                <span class="step-badge">Paso {{ task.process_number }}</span>
              </div>
              <div class="task-info">
                <span>Trabajador: {{ task.worker }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>