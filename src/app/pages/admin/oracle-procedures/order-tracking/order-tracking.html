<div class="order-tracking-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Seguimiento de Pedido</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="searchForm" class="search-form">
        <mat-form-field appearance="outline">
          <mat-label>ID del Pedido</mat-label>
          <input matInput type="number" formControlName="orderId" placeholder="Ej: 123">
          <mat-icon matIconPrefix>search</mat-icon>
          <mat-error *ngIf="searchForm.get('orderId')?.hasError('required')">
            El ID es requerido
          </mat-error>
          <mat-error *ngIf="searchForm.get('orderId')?.hasError('min')">
            Debe ser mayor a 0
          </mat-error>
        </mat-form-field>

        <button mat-raised-button color="primary" (click)="onSearch()" [disabled]="isLoading">
          <mat-icon>search</mat-icon>
          {{ isLoading ? 'Buscando...' : 'Buscar' }}
        </button>
      </form>

      <div *ngIf="isLoading" class="loading">
        Cargando información del pedido...
      </div>


      <div *ngIf="!isLoading && hasSearched && trackingData.length === 0" class="no-data">
        No se encontró información para este pedido
      </div>


      <div *ngIf="!isLoading && trackingData.length > 0" class="tracking-results">

        <div class="order-info">
          <h3>Información del Pedido #{{ trackingData[0].id_order }}</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="label">Cliente:</span>
              <span class="value">{{ trackingData[0].customer_name || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <span class="label">Teléfono:</span>
              <span class="value">{{ trackingData[0].customer_phone || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <span class="label">Dirección:</span>
              <span class="value">{{ trackingData[0].customer_address || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <span class="label">Fecha Entrada:</span>
              <span class="value">{{ trackingData[0].entry_date || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <span class="label">Fecha Estimada:</span>
              <span class="value">{{ trackingData[0].estimated_delivery_date || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <span class="label">Estado:</span>
              <span class="value badge">{{ trackingData[0].order_status || 'N/A' }}</span>
            </div>
          </div>
        </div>


        <div class="products-section">
          <h3>Productos del Pedido</h3>
          
          <mat-accordion>
            <mat-expansion-panel *ngFor="let group of groupedByProduct" [expanded]="true">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>inventory_2</mat-icon>
                  {{ group.tasks[0].product_name || 'Producto sin nombre' }}
                </mat-panel-title>
                <mat-panel-description>
                  {{ group.tasks[0].product_category || 'Sin categoría' }} - {{ group.tasks[0].product_status || 'Sin estado' }}
                </mat-panel-description>
              </mat-expansion-panel-header>


              <div class="product-details">
                <div class="detail-row">
                  <span class="label">Categoría:</span>
                  <span>{{ group.tasks[0].product_category || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Estado:</span>
                  <span>{{ group.tasks[0].product_status || 'N/A' }}</span>
                </div>
                <div class="detail-row" *ngIf="group.tasks[0].fabric">
                  <span class="label">Tela:</span>
                  <span>{{ group.tasks[0].fabric }}</span>
                </div>
                <div class="detail-row" *ngIf="group.tasks[0].dimensions">
                  <span class="label">Dimensiones:</span>
                  <span>{{ group.tasks[0].dimensions}}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Personalizado:</span>
                  <span>{{ group.tasks[0].customized || 'N/A' }}</span>
                </div>
              </div>

              <div class="tasks-timeline">
                <h4>Progreso de Producción</h4>
                <div class="timeline">
                  <div *ngFor="let task of group.tasks; let i = index" class="timeline-item">
                    <div class="timeline-marker" [class.completed]="task.task_end_date">
                      <mat-icon>{{ task.task_end_date ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                    </div>
                    <div class="timeline-content">
                      <div class="task-header">
                        <strong>Paso {{ task.sequence }}: {{ task.production_area || 'Área no especificada' }}</strong>
                        <span class="task-status" [ngClass]="getTaskStatusClass(task.task_status)">
                          {{ task.task_status || 'Sin estado' }}
                        </span>
                      </div>
                      <div class="task-details">
                        <div class="detail-row">
                          <mat-icon>person</mat-icon>
                          <span>{{ task.assigned_worker_name || 'Sin asignar' }} {{ task.worker_cc ? '(' + task.worker_cc + ')' : '' }}</span>
                        </div>
                        <div class="detail-row" *ngIf="task.task_start_date">
                          <mat-icon>schedule</mat-icon>
                          <span>Inicio: {{ task.task_start_date }}</span>
                        </div>
                        <div class="detail-row" *ngIf="task.task_end_date">
                          <mat-icon>done</mat-icon>
                          <span>Fin: {{ task.task_end_date}}</span>
                        </div>
                        <div class="detail-row" *ngIf="task.task_duration">
                          <mat-icon>timer</mat-icon>
                          <span>Duración: {{ task.task_duration }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>